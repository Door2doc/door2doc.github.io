openapi: "3.0.0"
info:
  title: Aansluitinformatie Gegevensuitwisseling HAP
  version: "2.0"

  description: |

    # Communicatie-stromen

    1. Afspraken – Topicus is de bron van deze data, en pusht deze naar door2doc. 
    2. Afspraakvoorstellen – Door2doc is de bron van deze data, Topicus vraagt de voorstellen op bij door2doc.
    3. Roosters – Topicus is de bron van deze data, en pusht deze naar door2doc.

    In alle gevallen is Topicus de initiator van de communicatie.
    
    ## Afspraken
    
    Voor afspraken zijn er drie stromen: 
    
    1. Incidentele export – deze wordt gebruikt bij het aansluiten van een nieuwe klant, en maakt gebruik van het endpoint
       `/topicus/export`. 
    2. Continue export – deze wordt gebruikt om afspraak-informatie tussen Topicus en door2doc in sync te houden. Dit is hetzelfde
       endpoint `/topicus/export`, maar wordt elke minuut aangeroepen. Deze export bevat alle afspraken die recent gewijzigd zijn, 
       met een limiet van 48h. 
    3. Directe updates – deze wordt gebruikt zodra er in Topicus een afspraak wordt aangemaakt, zodat het rooster van door2doc 
       in sync blijft met het rooster van Topicus. Deze updates bevatten minder informatie dan de continue export. Het relevante 
       endpoint is `/fhir/v3/Appointment`.
    
    ### Data
    
    In totaal verwerkt door2doc de volgende velden. Niet ieder veld is in iedere stroom aanwezig; zie de endpoint documentatie
    voor meer informatie. 
    
    * call ID – het CallID zoals gehanteerd in Topicus HAP. 
    * behandelplan ID – het Behandelplan ID zoals gehanteerd in TopPlan.  
    * lokatie – naam van de lokatie waar de afspraak is gepland
    * actie – soort afspraak; door2doc verwerkt niet alle soorten afspraak
    * agenda – naam van de agenda in TopPlan
    * urgentie – urgentie van de call, `"U0"` t/m `"U5"`. 
    * zelfverwijzer - boolean 
    * aannametijd – datum/tijd van aanname van de call
    * geplande tijd - datum/tijd waarom afspraak gepland is
    * aankomsttijd – datum/tijd waarop de patiënt gearriveerd is
    * begintijd – datum/tijd waarop de afspraak begonnen is
    * eindtijd – datum/tijd waarop de afspraak afgerond is
    * afrondtijd – datum/tijd waarop de afspraak administratief afgerond is
    * leeftijdsgroep – leeftijd van de patiënt in 5-jaars categorieën (`floor(leeftijd/5)`) 
    * postcode - 4 cijfers van de postcode
    * ingangsklachten - lijst van ingangsklachten van de patiënt
    * ICPC code – ICPC code van de call
    
    ## Roosters
    
    Voor roosters is er maar één stroom; deze loopt via FHIR en is gedocumenteerd onder `/fhir/v3/List`. 

    # Beveiliging

    De beveiliging van de communicatie-stroom naar door2doc bestaat uit de volgende niveaus:

    1. HTTPS:  alle verkeer _moet_ over HTTPS plaatsvinden.
    2. Authenticatie: alle requests naar deze service zijn geauthenticeerd met HTTP Basic Authenticatie

    # Technische constraints

    De service gaat uit van _at least once delivery_; dit betekent dat exact dezelfde afspraak meerdere malen geupload
    mag worden. Met andere woorden: bij het minste vermoeden dat een afspraak niet goed is geupload, kan deze opnieuw
    worden geupload. Dit betekent dat de upload van afspraken ook gebruikt kan worden om historische data te uploaden en/of
    periodieke totaaloverzichten te pushen.

servers:
  - url: https://integration.door2doc.net
    description: Integratie-server van door2doc

components:
  securitySchemes:
    BasicAuth:
      type: http
      scheme: basic

#  examples:
#    ScheduleList:
#      value:
#        resourceType: "List"
#
#    OperationalOutcomeSuccess:
#    {
#      "resourceType": "OperationOutcome",
#      "text": {
#        "status": "additional",
#        "div": "success"
#      },
#      "issue": [
#      {
#        "severity": "information",
#        "code": "informational",
#        "details": {
#          "text": "success"
#        }
#      }
#      ]
#    }
#
#    OperationalOutcomeAuth: {
#      "resourceType": "OperationOutcome",
#      "text": {
#        "status": "additional",
#        "div": "Unauthorized to access /fhir/v3/List"
#      },
#      "issue": [
#      {
#        "severity": "error",
#        "code": "security",
#        "details": {
#          "text": "not authorized"
#        },
#        "diagnostics": "..."
#      }
#      ]
#    }
#
#    OperationalOutcomeInvalid: {
#      "resourceType": "OperationOutcome",
#      "text": {
#        "status": "additional",
#        "div": "invalid resource"
#      },
#      "issue": [
#      {
#        "severity": "error",
#        "code": "processing",
#        "details": {
#          "text": "while determining resource type: invalid character 'u' looking for beginning of value"
#        },
#        "diagnostics": "..."
#      },
#      {
#        "severity": "error",
#        "code": "processing",
#        "details": {
#          "text": "invalid character 'u' looking for beginning of value"
#        },
#        "diagnostics": "..."
#      }
#      ]
#    }
#
#    OperationalOutcomeInternal: {
#      "resourceType": "OperationOutcome",
#      "text": {
#        "status": "additional",
#        "div": "failed to create resource"
#      },
#      "issue": [
#      {
#        "severity": "error",
#        "code": "processing",
#        "details": {
#          "text": "..."
#        },
#        "diagnostics": "..."
#      }
#      ]
#    }
#
#    AppointmentNew: {
#      "resourceType": "Appointment",
#      "contained": [
#      {
#        "resourceType": "Patient",
#        "id": "1",
#        "address": [
#        {
#          "postalCode": "1001",
#          "birthDate": "1970-07-11T08:30:00.000+02:00",
#        }
#        ]
#      },
#      {
#        "resourceType": "Location",
#        "id": "4",
#        "name": "Kamer 1",
#        "partOf": {
#          display: "LUMC"
#        }
#      }
#      ],
#      "identifier": [
#      {
#        "use": "secondary",
#        "system": "urn:topicuszorg:topplan:afspraaknummer",
#        "value": "123456789"
#      }
#      ],
#      "status": "booked",
#      "serviceType": [
#      {
#        "coding": [
#        {
#          "system": "urn:topicuszorg:topplan:afspraakprotocol:code",
#          "code": "HuisartsConsult"
#        }
#        ],
#      }
#      ],
#      "start": "2018-10-11T12:00:00.000+02:00",
#      "end": "2018-10-11T12:15:00.000+02:00",
#      "minutesDuration": 15,
#      "participant": [
#      {
#        "actor": {
#          "reference": "#4",
#          "display": "Kamer 1"
#        },
#        "status": "accepted"
#      },
#      {
#        "actor": {
#          "reference": "#2"
#        },
#        "status": "accepted"
#      }
#      ]
#    }


paths:
  /topicus/export/:
    post:
      summary: Regelmatige upload van recent afgeronde en openstaande afspraken.
      operationId: importAfspraken
      tags:
        - Afspraken
      security:
        - BasicAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                type: object
                properties:
                  call_id:
                    type: string
                  locatie:
                    type: string
                    example: "leiderdorp"
                  triage_urgentie:
                    type: string
                    enum: ["0", "1", "2", "3", "4", "5"]
                    example: "2"
                  afsluit_urgentie:
                    type: string
                    enum: ["0", "1", "2", "3", "4", "5"]
                    example: "2"
                  urgentie_gewijzigd:
                    type: boolean
                  zelfverwijzer:
                    type: boolean
                  aannametijd:
                    type: string
                    format: date-time
                  aankomsttijd:
                    type: string
                    format: date-time
                  originele_afspraak_begintijd:
                    type: string
                    format: date-time
                  urgent_gepland:
                    type: boolean
                  laatste_keer_openen_HA:
                    type: string
                    format: date-time
                  contact_begintijd:
                    type: string
                    format: date-time
                  contact_eindtijd:
                    type: string
                    format: date-time
                  fiatteertijd:
                    type: string
                    format: date-time
                  type_arts:
                    type: string
                    enum: ["Huisarts", "Visitearts", "Nurse-Practitioner"]
                  geboortedatum:
                    type: string
                    format: date-time
                  postcode:
                    type: string
                    example: "7401"
                  ingangsklacht:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        omschrijving:
                          type: string
                    example: [{"id": "45", "omschrijving": "Wond"}]
                  code_icpc:
                    type: string
                    example: "T91.01"
                  actie:
                    type: string
                    example: "Consult"
                  agenda:
                    type: string
                    example: "Kamer 1"
      responses:
        200:
          description: De export is succesvol verwerkt
          content:
            application/json:
              example: {
                "processed": 1
              }
        400:
          description: De export kon niet worden ingelezen
        403:
          description: Authenticatie probleem
        500:
          description: De export kon niet worden verwerkt

  /topicus/propose/:
    post:
      summary: Vraag een afspraak-voorstel op.
      tags:
        - Afspraakvoorstel
      description: | 
        Vraag een afspraak-voorstel op. De afspraak wordt ingeschoten als een FHIR appointment. Het resultaat is een
        FHIR Bundle met nul of meer Slots. De afspraak moet de volgende informatie bevatten:

        * appointmentType: onderscheid tussen zelfverwijzer en niet
        * reason: ingangsklachten van de patiënt
        * priority: initiële triagecode van de patiënt
        * birthdate: geboortedatum van de patiënt, afgerond op 1 januari; het jaar is idealiter afgerond op 5 jaar. 
        * postcode: eerste vier cijfers van de postcode van de patiënt, niet nodig voor zelfverwijzers
        * locatie van waar de call is aangenomen
        * tijdstip waarop de call is aangenomen

      operationId: propose
      security:
        - BasicAuth: []
      requestBody:
        description: Een FHIR Appointment
        required: true
        content:
          application/fhir+json:
            schema:
              example:
                {
                  "resourceType": "Appointment",
                  "contained": [
                    {
                      "resourceType": "Patient",
                      "id": "1",
                      "birthDate": "1999-01-01",
                      "address": [
                        {
                          "postalCode": "8607"
                        }
                      ]
                    },
                    {
                      "resourceType": "Location",
                      "id": "2",
                      "identifier": [
                        {
                          "use": "official",
                          "system": "urn:topicuszorg:topplan:plek:id",
                          "value": "933"
                        }
                      ],
                      "name": "Locatie A",
                      "managingOrganization": {
                        "reference": "#3"
                      }
                    },
                    {
                      "resourceType": "Organization",
                      "id": "3",
                      "name": "Dokterswacht Demo"
                    }
                  ],
                  "identifier": [
                    {
                      "system": "urn:topicuszorg:hap:callmodel:id",
                      "value": "5891892230"
                    }
                  ],
                  "status": "proposed",
                  "serviceType": [
                    {
                      "coding": [
                        {
                          "system": "urn:topicuszorg:topplan:afspraakprotocol:code",
                          "code": "ConsultHuisarts_15",
                          "display": "HA Locatie A"
                        },
                        {
                          "system": "urn:topicuszorg:topplan:afspraakprotocol:code",
                          "code": "ConsultHuisarts_15",
                          "display": "HA Locatie B"
                        },
                        {
                          "system": "urn:topicuszorg:topplan:afspraakprotocol:code",
                          "code": "ConsultHuisarts_15",
                          "display": "HA Locatie C"
                        }
                      ]
                    }
                  ],
                  "appointmentType": {
                    "coding": [
                      {
                        "system": "http://hl7.org/fhir/v2/0276",
                        "code": "WALKIN"
                      }
                    ]
                  },
                  "priority": 2,
                  "participant": [
                    {
                      "actor": {
                        "reference": "#1"
                      }
                    },
                    {
                      "actor": {
                        "reference": "#2"
                      }
                    }
                  ]
                }

      responses:
        200:
          description: Er is een afspraak voorstel beschikbaar. Het resultaat is een Bundle met nul of meer Slots.
          content:
            application/fhir+json:
              example: {
                "resourceType": "Bundle",
                "type": "searchset",
                "total": 2,
                "entry": [
                {
                  "resource": {
                    "resourceType": "Slot",
                    "schedule": {
                      "reference": "Schedule/35",
                    },
                    "start": "2019-03-18T13:15:00.000+01:00",
                    "end": "2019-03-18T13:30:00.000+01:00"
                  }
                },
                {
                  "resource": {
                    "resourceType": "Slot",
                    "schedule": {
                      "reference": "Schedule/37",
                    },
                    "start": "2019-03-18T13:15:00.000+01:00",
                    "end": "2019-03-18T13:30:00.000+01:00"
                  }
                }
                ]
              }

  /fhir/v3/List:
    post:
      summary: |
        Upload een schedule met 0 of meer slots. Het bestaande schedule wordt in zijn geheel vervangen door het nieuwe
        schedule.
      description: |
        Het model volgt het standaard FHIRv3 model voor `Schedule` en `Slot`.
      tags:
        - Roosters
      operationId: postList
      security:
        - BasicAuth: []
      requestBody:
        description: Een FHIR List met daarin één Schedule en 0 of meer Slots.
        required: true
        content:
          application/fhir+json:
            schema:
              example:
                {
                  "resourceType": "List",
                  "contained": [
                  {
                    "resourceType": "Schedule",
                    "id": "1",
                    "identifier": [
                    {
                      "system": "urn:topicuszorg:topplan:plekroosterblok:id",
                      "value": "1"
                    }
                    ],
                    "actor": [
                    {
                      "reference": "#3",
                    }
                    ],
                    "planningHorizon": {
                      "start": "2018-10-05T10:30:00+02:00",
                      "end": "2018-10-05T11:30:00+02:00"
                    }
                  },
                  {
                    "resourceType": "Slot",
                    "id": "2",
                    "serviceType": [
                    {
                      "coding": [
                      {
                        "system": "urn:topicuszorg:topplan:afspraakprotocol:code",
                        "code": "HuisartsConsult",
                      }
                      ]
                    }
                    ],
                    "schedule": {
                      "reference": "#1"
                    },
                    "status": "free",
                    "start": "2018-10-05T10:30:00.000+02:00",
                    "end": "2018-10-05T10:55:00.000+02:00"
                  },
                  {
                    "resourceType": "Location",
                    "id": "3",
                    "partOf": {
                      display: "LUMC"
                    }
                  }
                  ],
                  "status": "current",
                  "mode": "working",
                  "entry": [
                  {
                    "item": {
                      "reference": "#2"
                    }
                  },
                  ]
                }



      responses:
        201:
          description: De records zijn succesvol verwerkt. Het resultaat is beschreven in een OperationalOutcome.
        403:
          description: Er was een probleem met het authenticeren. Het probleem is beschreven in een OperationalOutcome.
        422:
          description: Er was een probleem met het uitlezen van één of meerdere resources. Het probleem is beschreven in een OperationalOutcome.
        500:
          description: Er was een probleem met het verwerken van de upload. Het probleem is beschreven in een OperationalOutcome.

  /fhir/v3/Appointment:
    post:
      summary: Registreer een afspraak. Een bestaande afspraak met hetzelfde ID wordt vervangen.
      description: |
        Dit endpoint volgt het standaard FHIRv3 model voor Appointment. 
        
        Bijzonderheden:
        * Voor de postcode worden alleen de eerste vier cijfers gebruikt.
        * Geboortedatum (indien aanwezig) wordt afgerond op 1 januari; idealiter wordt ook het jaartal afgerond op 5 jaar. 

      operationId: postAppointment
      tags:
        - Afspraken
      security:
        - BasicAuth: []
      requestBody:
        description: Een FHIR appointment.
        required: true
        content:
          application/fhir+json:
            schema:
              example:
                {
                  "contained": [
                    {
                      "id": "1",
                      "identifier": [
                        {
                          "system": "urn:topicuszorg:topplan:plek:id",
                          "use": "official",
                          "value": "918"
                        }
                      ],
                      "managingOrganization": {
                        "reference": "#2"
                      },
                      "name": "kamer 1",
                      "partOf": {
                        "reference": "#3"
                      },
                      "physicalType": {
                        "coding": [
                          {
                            "code": "si",
                            "display": "Site"
                          }
                        ]
                      },
                      "resourceType": "Location"
                    },
                    {
                      "id": "2",
                      "name": "HAP Dokterswacht Demo",
                      "resourceType": "Organization"
                    },
                    {
                      "address": {
                        "postalCode": "8441"
                      },
                      "id": "3",
                      "identifier": [
                        {
                          "system": "urn:topicuszorg:topplan:plek:id",
                          "use": "official",
                          "value": "917"
                        }
                      ],
                      "managingOrganization": {
                        "reference": "#4"
                      },
                      "name": "Locatie A",
                      "resourceType": "Location"
                    },
                    {
                      "id": "4",
                      "name": "HAP Dokterswacht Demo",
                      "resourceType": "Organization"
                    },
                    {
                      "gender": "unknown",
                      "id": "5",
                      "resourceType": "Patient"
                    }
                  ],
                  "created": "2022-07-01T07:33:10+02:00",
                  "end": "2022-07-01T08:00:00.000+02:00",
                  "identifier": [
                    {
                      "system": "urn:topicuszorg:topplan:afspraaknummer",
                      "value": "22070107209601"
                    },
                    {
                      "system": "urn:topicuszorg:topplan:afspraak:id",
                      "value": "2987073"
                    }
                  ],
                  "minutesDuration": 15,
                  "participant": [
                    {
                      "actor": {
                        "display": "afspraaklocatie",
                        "reference": "#1"
                      },
                      "status": "accepted"
                    },
                    {
                      "actor": {
                        "reference": "#5"
                      },
                      "status": "accepted"
                    }
                  ],
                  "priority": 3,
                  "resourceType": "Appointment",
                  "serviceType": [
                    {
                      "coding": [
                        {
                          "code": "ConsultHuisarts_15",
                          "display": "ConsultHuisarts_15"
                        }
                      ],
                      "text": "ConsultHuisarts_15"
                    }
                  ],
                  "start": "2022-07-01T07:45:00.000+02:00",
                  "status": "booked",
                  "supportingInformation": [
                    {
                      "identifier": {
                        "system": "urn:topicuszorg:topplan:behandelplan:id",
                        "value": "2998051"
                      }
                    },
                    {
                      "display": "afspraaklocatie",
                      "reference": "#1"
                    }
                  ]
                }

      responses:
        201:
          description: De afspraak is succesvol verwerkt. Het resultaat is beschreven in een OperationalOutcome.
        403:
          description: Er was een probleem met het authenticeren. Het probleem is beschreven in een OperationalOutcome.
        422:
          description: Er was een probleem met het uitlezen van de afspraak. Het probleem is beschreven in een OperationalOutcome.
        500:
          description: Er was een probleem met het verwerken van de afspraak. Het probleem is beschreven in een OperationalOutcome.

